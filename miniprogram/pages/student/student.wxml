<!-- å­¦ç”Ÿè®­ç»ƒé¡µé¢ -->
<view class="container">
  <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
  <view class="header" style="padding-top: {{statusBarHeight}}px;">
    <view class="header-content">
      <view class="profile-btn" bindtap="navigateToProfile">
        <text>ä¸ªäººè¯¦æƒ…</text>
      </view>
      <text class="header-title">è®­ç»ƒè¯¦æƒ…</text>
    </view>
  </view>
  <view class="date-selector">
    <view class="date-nav">
      <view class="date-arrow" bindtap="previousDay">â—€</view>
      <picker mode="date" value="{{selectedDate}}" start="2023-01-01" end="2025-12-31" bindchange="onDateChange" class="date-picker">
        <view class="selected-date">{{todayDate}} {{isToday ? '(ä»Šå¤©)' : ''}}</view>
      </picker>
      <view class="date-arrow" bindtap="nextDay">â–¶</view>
    </view>
  </view>
  <!-- æ ‡ç­¾é¡µ -->
  <view class="plan-tabs">
    <view class="plan-tab {{activeTab === 'training' ? 'active' : ''}}" bindtap="switchTab" data-tab="training">
      è®­ç»ƒåŠ¨ä½œ
    </view>
    <view class="plan-tab {{activeTab === 'diet' ? 'active' : ''}}" bindtap="switchTab" data-tab="diet">
      é¥®é£Ÿè®¡åˆ’
    </view>
    <view class="plan-tab {{activeTab === 'supplements' ? 'active' : ''}}" bindtap="switchTab" data-tab="supplements">
      è¡¥å‰‚å»ºè®®
    </view>
  </view>
  <!-- è®­ç»ƒåŠ¨ä½œå†…å®¹ -->
  <view class="tab-content" wx:if="{{activeTab === 'training'}}">
    <block wx:if="{{trainingDay}}">
      <view class="plan-day">
        <view class="day-title">
          <view>{{trainingDay.day}} ({{trainingDay.focus}})</view>
        </view>
        
        <!-- èº«ä½“çŠ¶å†µè®°å½•åŒºåŸŸ -->
        <view class="body-stats-container">
          <view class="body-stats-header">
            <text class="body-stats-title">èº«ä½“çŠ¶å†µè®°å½•</text>
            <view class="body-stats-edit" bindtap="toggleBodyStatsEdit">
              <text>{{isEditingBodyStats ? 'å®Œæˆ' : 'ç¼–è¾‘'}}</text>
            </view>
          </view>
          
          <view class="body-stats-grid">
            <!-- ä½“é‡ -->
            <view class="body-stat-item">
              <text class="stat-label">ä½“é‡</text>
              <view wx:if="{{!isEditingBodyStats}}" class="stat-value">{{bodyStats.weight || '--'}} </view>
              <input wx:else class="stat-input" type="digit" value="{{bodyStats.weight}}" placeholder="è¾“å…¥ä½“é‡" bindinput="onBodyStatInput" data-field="weight"/>
            </view>
            
            <!-- èƒ¸å›´ -->
            <view class="body-stat-item">
              <text class="stat-label">èƒ¸å›´</text>
              <view wx:if="{{!isEditingBodyStats}}" class="stat-value">{{bodyStats.chest || '--'}} </view>
              <input wx:else class="stat-input" type="digit" value="{{bodyStats.chest}}" placeholder="è¾“å…¥èƒ¸å›´" bindinput="onBodyStatInput" data-field="chest"/>
            </view>
            
            <!-- è‡€å›´ -->
            <view class="body-stat-item">
              <text class="stat-label">è‡€å›´</text>
              <view wx:if="{{!isEditingBodyStats}}" class="stat-value">{{bodyStats.hip || '--'}} </view>
              <input wx:else class="stat-input" type="digit" value="{{bodyStats.hip}}" placeholder="è¾“å…¥è‡€å›´" bindinput="onBodyStatInput" data-field="hip"/>
            </view>
            
            <!-- è‡‚å›´ -->
            <view class="body-stat-item">
              <text class="stat-label">è‡‚å›´</text>
              <view wx:if="{{!isEditingBodyStats}}" class="stat-value">{{bodyStats.arm || '--'}} </view>
              <input wx:else class="stat-input" type="digit" value="{{bodyStats.arm}}" placeholder="è¾“å…¥è‡‚å›´" bindinput="onBodyStatInput" data-field="arm"/>
            </view>
          </view>
          
          <!-- ä¸Šä¼ æ—©æ™¨ç©ºè…¹ç…§ç‰‡ -->
          <view class="body-photo-upload">
            <button class="upload-photo-btn" bindtap="uploadBodyPhoto" wx:if="{{!bodyStats.photoUrl}}">
              ä¸Šä¼ æ—©æ™¨ç©ºè…¹ç…§ç‰‡
            </button>
            <view class="body-photo-section" wx:if="{{bodyStats.photoUrl}}">
              <view class="section-title">æ—©æ™¨ç©ºè…¹ç…§ç‰‡</view>
              <image src="{{bodyStats.photoUrl}}" class="body-photo" mode="aspectFill" bindtap="previewImage" data-url="{{bodyStats.photoUrl}}"></image>
            </view>
          </view>
        </view>
        
        <view wx:for="{{trainingDay.exercises}}" wx:for-item="exercise" wx:key="name" class="workout-item {{exercise.completed ? 'completed' : ''}}">
          <view class="workout-header">
            <view class="workout-name">{{exercise.name}}</view>
            <view class="workout-completion">
              <view class="completion-checkbox" bindtap="toggleExerciseComplete" data-exercise-index="{{index}}">
                <text class="{{exercise.completed ? 'checkbox-checked' : 'checkbox-unchecked'}}"></text>
                <text class="{{exercise.completed ? 'completed-text' : 'incomplete-text'}}">
                  {{exercise.completed ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}}
                </text>
              </view>
            </view>
          </view>
          <!-- æ˜¾ç¤ºç»„æ•°ä¿¡æ¯ -->
          <view class="workout-sets">
            <view class="set-item" wx:for="{{exercise.sets}}" wx:for-item="set" wx:for-index="setIndex" wx:key="setIndex">
              <text class="set-number">ç»„{{setIndex + 1}}:</text>
              
              <!-- é‡é‡æ˜¾ç¤º/ç¼–è¾‘ -->
              <view class="editable-value" bindtap="startEditSet" data-exercise-index="{{index}}" data-set-index="{{setIndex}}" data-field="weight" wx:if="{{!(editingExerciseIndex === index && editingSetIndex === setIndex && editingField === 'weight')}}">
                <text class="set-weight">{{set.weight}}</text>
              </view>
              <input class="set-input weight-input" wx:else type="text" value="{{set.weight}}" focus="{{true}}" bindblur="saveSetEdit" bindinput="onSetEditInput" data-exercise-index="{{index}}" data-set-index="{{setIndex}}" data-field="weight"/>
              
              <view class="flex-spacer">Ã—</view>
              
              <!-- æ¬¡æ•°æ˜¾ç¤º/ç¼–è¾‘ -->
              <view class="editable-value" bindtap="startEditSet" data-exercise-index="{{index}}" data-set-index="{{setIndex}}" data-field="reps" wx:if="{{!(editingExerciseIndex === index && editingSetIndex === setIndex && editingField === 'reps')}}">
                <text class="set-reps">{{set.reps}}</text>
              </view>
              <input class="set-input reps-input" wx:else type="number" value="{{set.reps}}" focus="{{true}}" bindblur="saveSetEdit" bindinput="onSetEditInput" data-exercise-index="{{index}}" data-set-index="{{setIndex}}" data-field="reps"/>
            </view>
          </view>
          <view class="workout-note" wx:if="{{exercise.note}}">
            <text class="note-label">æ•™ç»ƒæç¤º:</text>
            <text class="note-content">{{exercise.note}}</text>
          </view>
          <!-- ä¸Šä¼ è®­ç»ƒè§†é¢‘ -->
          <view class="training-upload">
            <button class="upload-btn" bindtap="uploadVideo" data-exercise-index="{{index}}" wx:if="{{!exercise.videoUrl}}">
              ä¸Šä¼ è®­ç»ƒè§†é¢‘
            </button>
            <view class="student-video-section" wx:if="{{exercise.videoUrl}}">
              <view class="section-title">æˆ‘çš„è®­ç»ƒè§†é¢‘</view>
              <video src="{{exercise.videoUrl}}" class="exercise-video" object-fit="cover" show-center-play-btn="true" controls="true"></video>
            </view>
          </view>
          <!-- æ·»åŠ åé¦ˆæˆ–é—®é¢˜ -->
          <view class="feedback-section">
            <button class="question-btn" bindtap="askQuestion" data-exercise-index="{{index}}">
              {{exercise.question ? 'ä¿®æ”¹é—®é¢˜' : 'æé—®æ•™ç»ƒ'}}
            </button>
          </view>
          <!-- æ˜¾ç¤ºå·²æœ‰é—®é¢˜ -->
          <view class="student-question-section" wx:if="{{exercise.question}}">
            <view class="question-content">
              <text class="question-icon">â“</text>
              <text class="question-text">{{exercise.question}}</text>
            </view>
          </view>
          <!-- æ˜¾ç¤ºæ•™ç»ƒå›å¤ -->
          <view class="coach-answer-section" wx:if="{{exercise.answer}}">
            <view class="section-title">æ•™ç»ƒå›å¤</view>
            <view class="answer-content">
              <text class="answer-icon">ğŸ‘¨â€ğŸ«</text>
              <text class="answer-text">{{exercise.answer}}</text>
            </view>
          </view>
        </view>
      </view>
    </block>
    <view wx:else class="no-training">
      <view class="no-training-text">ä»Šæ—¥æ— è®­ç»ƒå®‰æ’</view>
    </view>
  </view>
  <!-- é¥®é£Ÿè®¡åˆ’å†…å®¹ -->
  <view class="tab-content" wx:if="{{activeTab === 'diet'}}">
    <view class="macro-nutrients-horizontal">
      <view class="macro-item">
        <view class="macro-value">{{dietPlan.calories}}kcal</view>
        <view class="macro-label">æ€»çƒ­é‡</view>
      </view>
      <view class="macro-item">
        <view class="macro-value">{{dietPlan.protein}}g</view>
        <view class="macro-label">è›‹ç™½è´¨</view>
      </view>
      <view class="macro-item">
        <view class="macro-value">{{dietPlan.carbs}}g</view>
        <view class="macro-label">ç¢³æ°´</view>
      </view>
      <view class="macro-item">
        <view class="macro-value">{{dietPlan.fat}}g</view>
        <view class="macro-label">è„‚è‚ª</view>
      </view>
    </view>
    <block wx:for="{{dietPlan.meals}}" wx:key="name" wx:for-item="meal" wx:for-index="mealIndex">
      <view class="meal-container {{meal.completed ? 'completed' : ''}}">
        <view class="meal-header">
          <view class="meal-title">
            <text>{{meal.name}}</text>
            <text wx:if="{{meal.time}}" class="meal-time">{{meal.time}}</text>
          </view>
          <view class="meal-completion">
            <view class="completion-checkbox" bindtap="toggleMealComplete" data-meal-index="{{mealIndex}}">
              <text class="{{meal.completed ? 'checkbox-checked' : 'checkbox-unchecked'}}"></text>
              <text class="{{meal.completed ? 'completed-text' : 'incomplete-text'}}">
                {{meal.completed ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}}
              </text>
            </view>
          </view>
        </view>
        <!-- æ˜¾ç¤ºé£Ÿç‰©ä¿¡æ¯ -->
        <view class="meal-item" wx:for="{{meal.foods}}" wx:for-item="food" wx:key="name">
          <view class="meal-item-content">
            <view class="meal-item-name">{{food.name}}</view>
            <view class="meal-item-amount">{{food.amount}}</view>
          </view>
        </view>
        <!-- ä¸Šä¼ é¥®é£Ÿå›¾ç‰‡ -->
        <view class="meal-image-upload">
          <button class="upload-image-btn" bindtap="uploadMealImage" data-meal-index="{{mealIndex}}" wx:if="{{!meal.imageUrl}}">
            ä¸Šä¼ é¥®é£Ÿå›¾ç‰‡
          </button>
          <view class="meal-image-section" wx:if="{{meal.imageUrl}}">
            <view class="section-title">é¥®é£Ÿè®°å½•</view>
            <image src="{{meal.imageUrl}}" class="meal-image" mode="aspectFill" bindtap="previewImage" data-url="{{meal.imageUrl}}"></image>
          </view>
        </view>
      </view>
    </block>
    <!-- é¥®é£Ÿæ³¨æ„äº‹é¡¹ -->
    <view class="diet-notes" wx:if="{{dietPlan.notes}}">
      <view class="diet-notes-header">
        <view class="diet-notes-title">é¥®é£Ÿæ³¨æ„äº‹é¡¹</view>
      </view>
      <view class="diet-notes-content">{{dietPlan.notes}}</view>
    </view>
    <!-- æ·»åŠ é¥®é£Ÿåé¦ˆ -->
    <view class="diet-feedback-section">
      <button class="diet-feedback-btn" bindtap="provideDietFeedback">
        {{dietFeedback ? 'ä¿®æ”¹é¥®é£Ÿåé¦ˆ' : 'æ·»åŠ é¥®é£Ÿåé¦ˆ'}}
      </button>
      <view class="diet-feedback" wx:if="{{dietFeedback}}">
        <text class="feedback-label">æˆ‘çš„é¥®é£Ÿåé¦ˆ:</text>
        <text class="feedback-content">{{dietFeedback}}</text>
      </view>
    </view>
  </view>
  <!-- è¡¥å‰‚å»ºè®®å†…å®¹ -->
  <view class="tab-content" wx:if="{{activeTab === 'supplements'}}">
    <!-- æ—©ä¸Šè¡¥å‰‚ -->
    <view class="supplement-container" wx:if="{{hasMorningSupplements}}">
      <view class="supplement-header">
        <view class="supplement-title">
          <text>æ—©ä¸Š</text>
        </view>
        <view class="supplement-completion">
          <view class="completion-checkbox" bindtap="toggleMorningSupplements">
            <text class="{{morningSupplementsCompleted ? 'checkbox-checked' : 'checkbox-unchecked'}}"></text>
            <text class="{{morningSupplementsCompleted ? 'completed-text' : 'incomplete-text'}}">
              {{morningSupplementsCompleted ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}}
            </text>
          </view>
        </view>
      </view>
      <!-- æ—©ä¸Šè¡¥å‰‚åˆ—è¡¨ -->
      <view class="supplement-list">
        <view wx:for="{{supplements}}" wx:key="name" wx:if="{{item.morning}}" class="supplement-item">
          <view class="supplement-name">{{item.name}}</view>
          <view class="supplement-dosage">{{item.morning}}</view>
        </view>
      </view>
    </view>
    <!-- ä¸­åˆè¡¥å‰‚ -->
    <view class="supplement-container" wx:if="{{hasNoonSupplements}}">
      <view class="supplement-header">
        <view class="supplement-title">
          <text>ä¸­åˆ</text>
        </view>
        <view class="supplement-completion">
          <view class="completion-checkbox" bindtap="toggleNoonSupplements">
            <text class="{{noonSupplementsCompleted ? 'checkbox-checked' : 'checkbox-unchecked'}}"></text>
            <text class="{{noonSupplementsCompleted ? 'completed-text' : 'incomplete-text'}}">
              {{noonSupplementsCompleted ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}}
            </text>
          </view>
        </view>
      </view>
      <!-- ä¸­åˆè¡¥å‰‚åˆ—è¡¨ -->
      <view class="supplement-list">
        <view wx:for="{{supplements}}" wx:key="name" wx:if="{{item.noon}}" class="supplement-item">
          <view class="supplement-name">{{item.name}}</view>
          <view class="supplement-dosage">{{item.noon}}</view>
        </view>
      </view>
    </view>
    <!-- è®­ç»ƒå‰è¡¥å‰‚ -->
    <view class="supplement-container" wx:if="{{hasPreWorkoutSupplements}}">
      <view class="supplement-header">
        <view class="supplement-title">
          <text>è®­ç»ƒå‰</text>
        </view>
        <view class="supplement-completion">
          <view class="completion-checkbox" bindtap="togglePreWorkoutSupplements">
            <text class="{{preWorkoutSupplementsCompleted ? 'checkbox-checked' : 'checkbox-unchecked'}}"></text>
            <text class="{{preWorkoutSupplementsCompleted ? 'completed-text' : 'incomplete-text'}}">
              {{preWorkoutSupplementsCompleted ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}}
            </text>
          </view>
        </view>
      </view>
      <!-- è®­ç»ƒå‰è¡¥å‰‚åˆ—è¡¨ -->
      <view class="supplement-list">
        <view wx:for="{{supplements}}" wx:key="name" wx:if="{{item.preWorkout}}" class="supplement-item">
          <view class="supplement-name">{{item.name}}</view>
          <view class="supplement-dosage">{{item.preWorkout}}</view>
        </view>
      </view>
    </view>
    <!-- è®­ç»ƒåè¡¥å‰‚ -->
    <view class="supplement-container" wx:if="{{hasPostWorkoutSupplements}}">
      <view class="supplement-header">
        <view class="supplement-title">
          <text>è®­ç»ƒå</text>
        </view>
        <view class="supplement-completion">
          <view class="completion-checkbox" bindtap="togglePostWorkoutSupplements">
            <text class="{{postWorkoutSupplementsCompleted ? 'checkbox-checked' : 'checkbox-unchecked'}}"></text>
            <text class="{{postWorkoutSupplementsCompleted ? 'completed-text' : 'incomplete-text'}}">
              {{postWorkoutSupplementsCompleted ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}}
            </text>
          </view>
        </view>
      </view>
      <!-- è®­ç»ƒåè¡¥å‰‚åˆ—è¡¨ -->
      <view class="supplement-list">
        <view wx:for="{{supplements}}" wx:key="name" wx:if="{{item.postWorkout}}" class="supplement-item">
          <view class="supplement-name">{{item.name}}</view>
          <view class="supplement-dosage">{{item.postWorkout}}</view>
        </view>
      </view>
    </view>
    <!-- æ™šä¸Šè¡¥å‰‚ -->
    <view class="supplement-container" wx:if="{{hasEveningSupplements}}">
      <view class="supplement-header">
        <view class="supplement-title">
          <text>æ™šä¸Š</text>
        </view>
        <view class="supplement-completion">
          <view class="completion-checkbox" bindtap="toggleEveningSupplements">
            <text class="{{eveningSupplementsCompleted ? 'checkbox-checked' : 'checkbox-unchecked'}}"></text>
            <text class="{{eveningSupplementsCompleted ? 'completed-text' : 'incomplete-text'}}">
              {{eveningSupplementsCompleted ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}}
            </text>
          </view>
        </view>
      </view>
      <!-- æ™šä¸Šè¡¥å‰‚åˆ—è¡¨ -->
      <view class="supplement-list">
        <view wx:for="{{supplements}}" wx:key="name" wx:if="{{item.evening}}" class="supplement-item">
          <view class="supplement-name">{{item.name}}</view>
          <view class="supplement-dosage">{{item.evening}}</view>
        </view>
      </view>
    </view>
    <!-- è¡¥å‰‚æ³¨æ„äº‹é¡¹ -->
    <view class="supplement-notes" wx:if="{{supplementNotes}}">
      <view class="supplement-notes-header">
        <view class="supplement-notes-title">è¡¥å‰‚æ³¨æ„äº‹é¡¹</view>
      </view>
      <view class="supplement-notes-content">{{supplementNotes}}</view>
    </view>
    <!-- æ·»åŠ è¡¥å‰‚åé¦ˆ -->
    <view class="supplement-feedback-section">
      <button class="supplement-feedback-btn" bindtap="provideSupplementFeedback">
        {{supplementFeedback ? 'ä¿®æ”¹è¡¥å‰‚åé¦ˆ' : 'æ·»åŠ è¡¥å‰‚åé¦ˆ'}}
      </button>
      <view class="supplement-feedback" wx:if="{{supplementFeedback}}">
        <text class="feedback-label">æˆ‘çš„è¡¥å‰‚åé¦ˆ:</text>
        <text class="feedback-content">{{supplementFeedback}}</text>
      </view>
    </view>
  </view>
  <!-- åº•éƒ¨ä¿å­˜æŒ‰é’® -->
  <view class="bottom-actions">
    <button class="save-btn" bindtap="saveAllData">ä¿å­˜å½“æ—¥è®­ç»ƒ</button>
  </view>
</view>