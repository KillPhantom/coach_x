<!-- è®­ç»ƒè®¡åˆ’è¯¦æƒ…é¡µé¢ -->
<view class="header" style="padding-top: {{statusBarHeight}}px;">
  <view class="back-button" bindtap="goBack">â†</view>
  è®­ç»ƒè®¡åˆ’è¯¦æƒ…
</view>

<view class="container container-with-tabs">
  <view class="content-wrapper">
    <!-- å­¦å‘˜ä¿¡æ¯éƒ¨åˆ†ï¼Œä»…åœ¨éæ–°è®¡åˆ’æ¨¡å¼ä¸‹æ˜¾ç¤º -->
    <view class="student-header" wx:if="{{student.id !== 0}}">
      <view class="avatar" style="{{student.avatarStyle}}">{{student.avatar}}</view>
      <view class="student-info">
        <view class="student-name">{{student.name}} - {{student.planName}}</view>
        <view class="student-tags">
          <text class="tag {{student.phaseTagClass}}">{{student.phase}}</text>
          <text class="tag">ç¬¬{{student.week}}å‘¨</text>
        </view>
      </view>
    </view>
    
    <!-- èº«ä½“çŠ¶æ€æ ï¼Œä»…åœ¨éæ–°è®¡åˆ’æ¨¡å¼ä¸‹æ˜¾ç¤º -->
    <view class="body-stats" wx:if="{{student.id !== 0}}">
      <view class="stat-item">
        <view class="stat-value">{{student.height}}cm</view>
        <view class="stat-label">èº«é«˜</view>
      </view>
      <view class="stat-item">
        <view class="stat-value">{{student.weight}}kg</view>
        <view class="stat-label">ä½“é‡</view>
      </view>
      <view class="stat-item">
        <view class="stat-value {{student.weightChange > 0 ? 'increase' : (student.weightChange < 0 ? 'decrease' : '')}}">
          {{student.weightChange > 0 ? '+' : ''}}{{student.weightChange}}kg
        </view>
        <view class="stat-label">æœ¬å‘¨å˜åŒ–</view>
      </view>
    </view>
    
    <!-- AIåˆ†æå¡ç‰‡ï¼Œä»…åœ¨éæ–°è®¡åˆ’æ¨¡å¼ä¸‹æ˜¾ç¤º -->
    <view class="ai-insight" wx:if="{{student.id !== 0 && aiAnalysis}}">
      <view class="ai-insight-container">
        <view class="ai-insight-icon">
          <text>ğŸ¤–</text>
        </view>
        <view class="ai-insight-content">
          <view class="ai-insight-title">AIè®­ç»ƒåˆ†æ</view>
          <view class="ai-insight-text">
            <text wx:if="{{loading.aiAnalysis}}">åŠ è½½ä¸­...</text>
            <block wx:else>
              <view>æ ¹æ®{{student.name}}çš„è®­ç»ƒå†å²å’Œèº«ä½“æ•°æ®ï¼Œä»¥ä¸‹æ˜¯AIçš„å»ºè®®ï¼š</view>
              <view class="ai-suggestions">
                <view class="ai-suggestion-item" wx:for="{{aiAnalysis.suggestions}}" wx:key="index">
                  â€¢ {{item}}
                </view>
              </view>
              <view class="ai-analysis-source">
                åˆ†æåŸºäºæœ€è¿‘{{aiAnalysis.weeks}}å‘¨çš„è®­ç»ƒæ•°æ®å’Œ{{aiAnalysis.tests}}æ¬¡ä½“æµ‹ç»“æœ
              </view>
            </block>
          </view>
        </view>
      </view>
    </view>
    
    <!-- å†…ç½®æ ‡ç­¾é¡µ -->
    <view class="plan-tabs">
      <view class="plan-tab {{activeTab === 'training' ? 'active' : ''}}" bindtap="switchPlanTab" data-tab="training">
        è®­ç»ƒåŠ¨ä½œ
      </view>
      <view class="plan-tab {{activeTab === 'diet' ? 'active' : ''}}" bindtap="switchPlanTab" data-tab="diet">
        é¥®é£Ÿè®¡åˆ’
      </view>
      <view class="plan-tab {{activeTab === 'supplements' ? 'active' : ''}}" bindtap="switchPlanTab" data-tab="supplements">
        è¡¥å‰‚å»ºè®®
      </view>
    </view>

    <!-- è®­ç»ƒåŠ¨ä½œå†…å®¹ -->
    <view class="tab-content" wx:if="{{activeTab === 'training'}}">
      <!-- æ·»åŠ è®­ç»ƒæ—¥æŒ‰é’® -->
      <view class="add-training-day" bindtap="addTrainingDay">
        <text>+ æ·»åŠ è®­ç»ƒæ—¥</text>
      </view>

      <block wx:for="{{trainingDays}}" wx:key="day" wx:for-index="dayIndex">
        <view class="plan-day">
          <view class="day-title">
            <view>{{item.day}} ({{item.focus}})</view>
            <view class="day-actions">
              <text class="day-action-btn" bindtap="addExercise" data-day-index="{{dayIndex}}">+</text>
              <text class="day-action-btn" bindtap="editTrainingDay" data-day-index="{{dayIndex}}">ç¼–è¾‘</text>
              <text class="day-action-btn delete-btn" bindtap="deleteTrainingDay" data-day-index="{{dayIndex}}">åˆ é™¤</text>
            </view>
          </view>
          
          <view wx:for="{{item.exercises}}" wx:for-item="exercise" wx:key="name" wx:for-index="exerciseIndex"
                class="workout-item {{exercise.highlight ? 'highlight-' + exercise.highlight : ''}}">
            <view class="workout-header">
              <view class="workout-name">{{exercise.name}}</view>
              <view class="workout-actions">
                <text class="edit-btn" bindtap="editExercise" data-day-index="{{dayIndex}}" data-exercise-index="{{exerciseIndex}}">ç¼–è¾‘</text>
                <text class="delete-btn" bindtap="deleteExercise" data-day-index="{{dayIndex}}" data-exercise-index="{{exerciseIndex}}">åˆ é™¤</text>
              </view>
            </view>
            
            <!-- å¤šç»„è®­ç»ƒæ˜¾ç¤º -->
            <view class="workout-sets">
              <view class="workout-set" wx:for="{{exercise.sets}}" wx:for-item="set" wx:key="index" wx:for-index="setIndex">
                <text>ç»„{{setIndex + 1}}: {{set.weight}} Ã— {{set.reps}}</text>
              </view>
            </view>
            
            <!-- æ•™ç»ƒå¤‡æ³¨ -->
            <view class="workout-note" wx:if="{{exercise.note}}">
              <view class="note-title">æ•™ç»ƒæç¤º:</view>
              <view class="note-content">{{exercise.note}}</view>
            </view>
          </view>
        </view>
      </block>
    </view>

    <!-- é¥®é£Ÿè®¡åˆ’å†…å®¹ -->
    <view class="tab-content" wx:if="{{activeTab === 'diet'}}">
      <view class="plan-day">
        <!-- å®é‡è¥å…»ç´ æ¦‚è§ˆ -->
        <view class="diet-overview">
          <view class="diet-macro">
            <view class="diet-macro-value">{{dietPlan.calories}}kcal</view>
            <view class="diet-macro-label">æ€»çƒ­é‡</view>
          </view>
          <view class="diet-macro">
            <view class="diet-macro-value">{{dietPlan.protein}}g</view>
            <view class="diet-macro-label">è›‹ç™½è´¨</view>
          </view>
          <view class="diet-macro">
            <view class="diet-macro-value">{{dietPlan.carbs}}g</view>
            <view class="diet-macro-label">ç¢³æ°´</view>
          </view>
          <view class="diet-macro">
            <view class="diet-macro-value">{{dietPlan.fat}}g</view>
            <view class="diet-macro-label">è„‚è‚ª</view>
          </view>
          <view class="diet-macro-edit">
            <text class="edit-btn" bindtap="editMacros">ç¼–è¾‘</text>
          </view>
        </view>

        <!-- é¤æ¬¡åˆ—è¡¨ -->
        <block wx:for="{{dietPlan.meals}}" wx:key="name" wx:for-index="mealIndex">
          <view class="meal-section">
            <view class="meal-header">
              <view class="meal-title">{{item.name}}</view>
              <view class="meal-actions">
                <text class="meal-action-btn" bindtap="addFood" data-meal-index="{{mealIndex}}">+</text>
                <text class="delete-btn" bindtap="deleteMeal" data-meal-index="{{mealIndex}}">åˆ é™¤</text>
              </view>
            </view>
            
            <view class="meal-item" wx:for="{{item.foods}}" wx:for-item="food" wx:key="name" wx:for-index="foodIndex">
              <view class="meal-item-content">
                <view class="meal-item-name">{{food.name}}</view>
                <view class="meal-item-amount">{{food.amount}}</view>
              </view>
              <view class="item-actions">
                <text class="edit-btn" bindtap="editFood" data-meal-index="{{mealIndex}}" data-food-index="{{foodIndex}}">ç¼–è¾‘</text>
                <text class="delete-btn" bindtap="deleteFood" data-meal-index="{{mealIndex}}" data-food-index="{{foodIndex}}">åˆ é™¤</text>
              </view>
            </view>
          </view>
        </block>

        <!-- æ·»åŠ é¤æ¬¡æŒ‰é’® - æ”¹ä¸ºè§¦å‘å¿«é€Ÿæ·»åŠ åŠŸèƒ½ -->
        <view class="add-meal-btn" bindtap="quickAddMeal">
          + æ·»åŠ é¤æ¬¡
        </view>

        <!-- é¥®é£Ÿæ³¨æ„äº‹é¡¹ -->
        <view class="diet-notes" wx:if="{{dietPlan.notes}}">
          <view class="diet-notes-header">
            <view class="diet-notes-title">é¥®é£Ÿæ³¨æ„äº‹é¡¹</view>
            <view class="diet-notes-action">
              <text class="edit-btn" bindtap="editDietNotes">ç¼–è¾‘</text>
            </view>
          </view>
          <view class="diet-notes-content">{{dietPlan.notes}}</view>
        </view>
      </view>
    </view>

    <!-- è¡¥å‰‚å»ºè®®å†…å®¹ -->
    <view class="tab-content" wx:if="{{activeTab === 'supplements'}}">
      <view class="plan-day">
        <view class="day-title">
          <view>è¡¥å‰‚å»ºè®®</view>
          <view class="day-actions">
            <text class="day-action-btn" bindtap="addSupplement">+ æ·»åŠ è¡¥å‰‚</text>
          </view>
        </view>
        
        <!-- è¡¥å‰‚è¡¨æ ¼ -->
        <view class="supplement-table">
          <view class="supplement-table-header">
            <view class="supplement-name-header">è¡¥å‰‚åç§°</view>
            <view class="supplement-time-header">æ—©ä¸Š</view>
            <view class="supplement-time-header">ä¸­åˆ</view>
            <view class="supplement-time-header">æ™šä¸Š</view>
            <view class="supplement-action-header">æ“ä½œ</view>
          </view>
          
          <view class="supplement-table-row" wx:for="{{supplements}}" wx:key="name" wx:for-index="supplementIndex">
            <view class="supplement-name-cell">{{item.name}}</view>
            <view class="supplement-time-cell" bindtap="editSupplementDosage" data-supplement-index="{{supplementIndex}}" data-time="morning">
              {{item.morning || '-'}}
            </view>
            <view class="supplement-time-cell" bindtap="editSupplementDosage" data-supplement-index="{{supplementIndex}}" data-time="noon">
              {{item.noon || '-'}}
            </view>
            <view class="supplement-time-cell" bindtap="editSupplementDosage" data-supplement-index="{{supplementIndex}}" data-time="evening">
              {{item.evening || '-'}}
            </view>
            <view class="supplement-action-cell">
              <text class="edit-btn" bindtap="editSupplement" data-supplement-index="{{supplementIndex}}">ç¼–è¾‘</text>
              <text class="delete-btn" bindtap="deleteSupplement" data-supplement-index="{{supplementIndex}}">åˆ é™¤</text>
            </view>
          </view>
        </view>
        
        <!-- è¡¥å‰‚è¯´æ˜ -->
        <view class="supplement-notes" wx:if="{{supplementNotes}}">
          <view class="supplement-notes-header">
            <view class="supplement-notes-title">è¡¥å……è¯´æ˜</view>
            <view class="supplement-notes-action">
              <text class="edit-btn" bindtap="editSupplementNotes">ç¼–è¾‘</text>
            </view>
          </view>
          <view class="supplement-notes-content">{{supplementNotes}}</view>
        </view>
      </view>
    </view>
    
    <!-- æ“ä½œæŒ‰é’® -->
    <view class="action-buttons">
      <button class="button button-primary" bindtap="savePlan">
        <text class="button-icon">ğŸ’¾</text> ä¿å­˜è®¡åˆ’
      </button>
      <button class="button button-outline" bindtap="showTemplateOptions">
        <text class="button-icon">ğŸ“‹</text> æ¨¡æ¿æ“ä½œ
      </button>
    </view>
  </view>
  
</view> 